server {
	listen  80;

	server_name addons.vkzvuk.ru;
	server_name www.vkzvuk.ru;
	server_name vkzvuk.ru; 
	rewrite ^ https://vkzvuk.ru$request_uri? permanent;
} 

server {
	listen  443;
	listen 80;
	include /etc/nginx/ssl/vkzvuk.conf;   

	server_name  assets.vkzvuk.ru;
	root /srv/http/assets.vkzvuk.ru; 

 	access_log  /var/log/http/assets.vkzvuk_nginx_access.log  main;  

	rewrite ^/$ https://vkzvuk.ru break;
} 
 

server {
	listen 443;
	include /etc/nginx/ssl/vkzvuk.conf;  

	server_name vkzvuk.ru;
	root /srv/http/vkzvuk.ru;  

	charset utf-8;
	access_log  /var/log/http/vkzvuk_nginx_access.log  main; 
	error_log   /var/log/http/vkzvuk_nginx_error.log  warn;  
	index index.html;

	add_header X-Frame-Options DENY;
	add_header X-Content-Type-Options nosniff;
	add_header X-XSS-Protection "1; mode=block;";

	if ($http_user_agent ~* (nmap|nikto|wikto|sf|sqlmap|bsqlbf|w3af|acunetix|havij|appscan)){
		return 403;
	}

	rewrite ^/(.*)/$ /$1 permanent;
	rewrite ^/policy /privacy permanent;

	location ~* ^\/update\/(.*)\/(.*)\.(xml|rdf)$ {
		types {
 			text/html rdf, html;
			text/xml xml; 
		}
		alias /srv/http/addons.vkzvuk.ru/update/$1-$2.$3;
	}
 
	location ~* ^\/update\/(.*)\/.*\.(crx|oex|xpi)$ {
		types {			
			application/x-xpinstall xpi;
			application/x-chrome-extension crx;
			application/x-opera-extension oex;						
		}  
		alias /srv/http/addons.vkzvuk.ru/release/$1.$2;
	}                                        

	location ~* ^\/download\/(.*)\/.*\.(crx|oex|xpi)$ {
		types {			
			application/x-xpinstall xpi;
			application/octet-stream crx;
			application/octet-stream oex;						
		}  
		alias /srv/http/addons.vkzvuk.ru/release/$1.$2;
	}                                        
 

	location ~* \.(css|png|jpg|jpeg|gif|ico|js)$ {
		expires 2w;
		log_not_found off;
	}

	location = /favicon.ico {
		log_not_found off;
		access_log off;
		rewrite ^.*$	/assets/images/favicon.ico break;
	}

	location = /robots.txt {
		allow all;
		log_not_found off;
		access_log off;
	}

	location = / {
		index index.html;
	}

	location / {
		try_files $uri $uri/ /pages/$uri/index.html  /script.php?$args;
	}   

	location = /script.php {
		include fastcgi_params; 
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Request-Filename $request_filename;

		fastcgi_param SCRIPT_FILENAME /srv/http/$host$fastcgi_script_name;
		fastcgi_param QUERY_STRING    $query_string;
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		proxy_read_timeout 512;
		fastcgi_pass 127.0.0.1:9000;
	}

	location ~ \.php$ {
		deny all;
	}  
}
